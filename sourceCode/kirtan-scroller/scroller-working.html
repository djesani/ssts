<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kirtans</title>
    <style>
        body {
            background-color: #fff2e6;
            color: #990101;
            overflow: hidden;
        }

        :root {
            --default-color: #990101;
            --highlight-color: #ff6a00;
            --transition-duration: 500ms;
        }

        #title {
            font-size: 40px;
            text-align: center;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        .list-item {
            padding: 5px 0;
            font-size: 30px;
            width: 100%;
            text-align: center;
            color: var(--default-color);
            font-weight: normal;
            transition: all linear var(--transition-duration);
            position: absolute;
        }

        .list-item.no-animation {
            transition: none;
        }

        .english {
            font-weight: bold;
        }

        #config-panel {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: #fff2e6;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
            transition: right 0.3s;
            padding: 20px;
            overflow-y: auto;
        }

        #config-panel.open {
            right: 0;
        }

        #config-panel label {
            display: block;
            margin: 15px 0 5px;
        }

        #config-panel input[type="color"],
        #config-panel select,
        #config-panel input[type="checkbox"] {
            width: 100%;
        }

        #config-panel input[type="checkbox"] {
            display: inline-block;
            margin-right: 5px;
        }

        #config-panel label.checkbox {
            display: flex;
        }

        #config-panel input[type="checkbox"] {
            margin: 2px 9px 0 0;
            width: 16px;
            height: 16px;
        }
    </style>

    <style id="dynamic-styles"></style>
</head>

<body>
    <h1 id="title"></h1>
    <ul id="list" class="list"></ul>

    <div id="config-panel">
        <button onclick="toggleConfigPanel()">Close Config Panel</button>
        <label for="num-lines">Number of Lines:</label>
        <select id="num-lines">
            <option value="5">5</option>
            <option value="7">7</option>
            <option value="9">9</option>
            <option value="11">11</option>
        </select>

        <label for="highlight-color">Background Color:</label>
        <input type="color" id="background-color" value="##fff2e6">

        <label for="default-color">Default Color:</label>
        <input type="color" id="default-color" value="#990101">

        <label for="highlight-color">Highlight Color:</label>
        <input type="color" id="highlight-color" value="#ff6a00">

        <label class="checkbox">
            <input type="checkbox" id="toggle-font-size" onchange="toggleFontSize()"> Toggle Font Size
        </label>
        <label class="checkbox">
            <input type="checkbox" id="toggle-opacity" onchange="toggleOpacity()"> Toggle Opacity
        </label>
        <label class="checkbox">
            <input type="checkbox" id="toggle-english" onchange="toggleEnglish()"> Show English
        </label>
        <label class="checkbox">
            <input type="checkbox" id="toggle-gujarati" onchange="toggleGujarati()"> Show Gujarati
        </label>

        <label for="transition-duration">Transition Duration (ms):</label>
        <select id="transition-duration">
            <option value="200">200</option>
            <option value="400">400</option>
            <option value="600">600</option>
            <option value="800">800</option>
            <option value="1000">1000</option>
        </select>

        <label for="font-size">Font Size (px):</label>
        <select id="font-size">
            <option value="16">16</option>
            <option value="24">24</option>
            <option value="32">32</option>
            <option value="40">40</option>
            <option value="48">48</option>
        </select>

        <button onclick="saveConfig()">Save Config</button>
    </div>

    <script>
        let kirtanJson,
            slides,
            slidesGujarati,
            title,
            index = 0;
        let numLines = parseInt(localStorage.getItem('numLines')) || 7;
        let enableFontSize = JSON.parse(localStorage.getItem('enableFontSize')) || true;
        let enableOpacity = JSON.parse(localStorage.getItem('enableOpacity')) || true;
        let showEnglish = JSON.parse(localStorage.getItem('showEnglish')) || true;
        let showGujarati = JSON.parse(localStorage.getItem('showGujarati')) || true;
        const list = document.getElementById("list");
        const highlightIndex = Math.floor(numLines / 2) + 1;
        const stepsFromHighlight = highlightIndex - 1;

        document.addEventListener("keydown", (event) => {
            if (event.key === "ArrowUp") {
                if (index + stepsFromHighlight > 0) prev();
            } else if (event.key === "ArrowDown") {
                if (index - stepsFromHighlight < slides.length - numLines) next();
            }
        });

        async function loadData() {
            const response = await fetch("data.json");
            kirtanJson = await response.json();
            const id = getUrlParamsId();
            const kirtan = getKirtanById(id);
            title = kirtan.title_english;
            slides = kirtan.description_english.split("\n");
            slidesGujarati = kirtan.description_gujarati.split("\n");
            injectStyles(generateDynamicStyles(numLines));
            renderTitle();
            renderSlides();
            adjustToHighlightFirst();
        }

        function renderTitle() {
            document.getElementById("title").innerText = title;
        }

        function getKirtanById(id) {
            return kirtanJson.data.find((x) => x.id == id) || kirtanJson.data[0];
        }

        function getUrlParamsId() {
            const urlSearch = new URLSearchParams(window.location.search);
            return urlSearch.get("id") || 1;
        }

        function renderSlides() {
            list.innerHTML = "";
            for (let i = 0; i < numLines; i++) {
                const li = document.createElement("li");
                li.className = "list-item";

                const eng = document.createElement("div");
                eng.innerText = slides[index + i] || "";
                eng.className = "english";
                eng.style.display = showEnglish ? "block" : "none";

                const guj = document.createElement("div");
                guj.innerText = slidesGujarati[index + i] || "";
                guj.className = "gujarati";
                guj.style.display = showGujarati ? "block" : "none";

                li.appendChild(eng);
                li.appendChild(guj);
                list.appendChild(li);
            }
        }

        function prev() {
            transitionSlides("down", -1);
        }

        function next() {
            transitionSlides("up", 1);
        }

        function transitionSlides(animationClass, step) {
            toggleAnimationClasses(false);
            list.classList.add(animationClass);
            setTimeout(() => {
                toggleAnimationClasses(true);
                list.classList.remove(animationClass);
                index += step;
                renderSlides();
            }, parseInt(getComputedStyle(document.documentElement).getPropertyValue("--transition-duration")));
        }

        function toggleAnimationClasses(remove) {
            const method = remove ? "add" : "remove";
            document.querySelectorAll(".list-item").forEach((item) => {
                item.classList[method]("no-animation");
            });
        }

        function generateDynamicStyles(numLines) {
            let styles = "";
            const viewportHeight = window.innerHeight;
            const itemHeight = viewportHeight / numLines;
            const middlePosition = viewportHeight / 2 - itemHeight / 2;

            for (let i = 1; i <= numLines; i++) {
                const topPosition = middlePosition + (i - highlightIndex) * itemHeight;
                const color = i === highlightIndex ? "var(--highlight-color)" : "inherit";
                const opacity = calculateOpacity(i, highlightIndex, numLines);
                const fontSize = calculateFontSize(i, highlightIndex, numLines);
                styles += `.list .list-item:nth-child(${i}) { top: ${topPosition}px; opacity: ${opacity}; color: ${color}; font-size: ${fontSize}px; }\n`;
            }

            for (let i = 2; i <= numLines + 1; i++) {
                const topPosition = middlePosition + (i - 1 - highlightIndex) * itemHeight;
                const color = i - 1 === highlightIndex ? "var(--highlight-color)" : "inherit";
                const opacity = calculateOpacity(i - 1, highlightIndex, numLines);
                const fontSize = calculateFontSize(i - 1, highlightIndex, numLines);
                styles += `.list.up .list-item:nth-child(${i}) { top: ${topPosition}px; opacity: ${opacity}; color: ${color}; font-size: ${fontSize}px; }\n`;
            }

            for (let i = 1; i <= numLines - 1; i++) {
                const topPosition = middlePosition + (i + 1 - highlightIndex) * itemHeight;
                const color = i + 1 === highlightIndex ? "var(--highlight-color)" : "inherit";
                const opacity = calculateOpacity(i + 1, highlightIndex, numLines);
                const fontSize = calculateFontSize(i + 1, highlightIndex, numLines);
                styles += `.list.down .list-item:nth-child(${i}) { top: ${topPosition}px; opacity: ${opacity}; color: ${color}; font-size: ${fontSize}px; }\n`;
            }

            return styles;
        }

        function calculateOpacity(index, highlightIndex, numLines) {
            if (!enableOpacity) return 1;
            if (index === 1 || index === numLines) return 0;
            const distanceFromCenter = Math.abs(highlightIndex - index);
            const maxDistance = Math.floor(numLines / 2);
            return 1 - distanceFromCenter / maxDistance;
        }

        function calculateFontSize(index, highlightIndex, numLines) {
            if (!enableFontSize) return parseInt(document.getElementById('font-size').value) || 30;
            const baseFontSize = parseInt(document.getElementById('font-size').value) || 30;
            return index === highlightIndex ? baseFontSize : baseFontSize * 0.8;
        }

        function injectStyles(styles) {
            const styleSheet = document.getElementById("dynamic-styles");
            styleSheet.textContent = styles;
        }

        function adjustToHighlightFirst() {
            for (let i = 0; i < stepsFromHighlight; i++) {
                prev();
            }
        }

        function toggleConfigPanel() {
            const panel = document.getElementById("config-panel");
            panel.classList.toggle("open");
        }

        function toggleFontSize() {
            enableFontSize = !enableFontSize;
            localStorage.setItem('enableFontSize', enableFontSize);
            injectStyles(generateDynamicStyles(numLines));
        }

        function toggleOpacity() {
            enableOpacity = !enableOpacity;
            localStorage.setItem('enableOpacity', enableOpacity);
            injectStyles(generateDynamicStyles(numLines));
        }

        function toggleEnglish() {
            showEnglish = !showEnglish;
            localStorage.setItem('showEnglish', showEnglish);
            renderSlides();
        }

        function toggleGujarati() {
            showGujarati = !showGujarati;
            localStorage.setItem('showGujarati', showGujarati);
            renderSlides();
        }

        function updateTransitionDuration() {
            const duration = document.getElementById('transition-duration').value;
            document.documentElement.style.setProperty('--transition-duration', `${duration}ms`);
            localStorage.setItem('transitionDuration', duration);
        }

        function updateFontSize() {
            injectStyles(generateDynamicStyles(numLines));
            localStorage.setItem('fontSize', document.getElementById('font-size').value);
        }

        function saveConfig() {
            const numLinesInput = document.getElementById("num-lines");
            const defaultBackroundColorInput = document.getElementById("background-color");
            const defaultColorInput = document.getElementById("default-color");
            const highlightColorInput = document.getElementById("highlight-color");

            numLines = parseInt(numLinesInput.value);
            const defaultBackroundColor = defaultBackroundColorInput.value;
            const defaultColor = defaultColorInput.value;
            const highlightColor = highlightColorInput.value;

            document.documentElement.style.setProperty('--default-color', defaultColor);
            document.documentElement.style.setProperty('--highlight-color', highlightColor);

            localStorage.setItem('numLines', numLines);
            localStorage.setItem('defaultBackroundColorInput', defaultBackroundColorInput);
            localStorage.setItem('defaultColor', defaultColor);
            localStorage.setItem('highlightColor', highlightColor);

            injectStyles(generateDynamicStyles(numLines));
            renderSlides();
        }

        function loadConfig() {
            const numLinesValue = localStorage.getItem('numLines');
            const defaultBackgroundColorValue = localStorage.getItem('defaultBackgroundColor');
            const defaultColorValue = localStorage.getItem('defaultColor');
            const highlightColorValue = localStorage.getItem('highlightColor');
            const enableFontSizeValue = JSON.parse(localStorage.getItem('enableFontSize'));
            const enableOpacityValue = JSON.parse(localStorage.getItem('enableOpacity'));
            const showEnglishValue = JSON.parse(localStorage.getItem('showEnglish'));
            const showGujaratiValue = JSON.parse(localStorage.getItem('showGujarati'));
            const transitionDurationValue = localStorage.getItem('transitionDuration');
            const fontSizeValue = localStorage.getItem('fontSize');

            if (numLinesValue) {
                document.getElementById('num-lines').value = numLinesValue;
                numLines = parseInt(numLinesValue);
            }
            if (defaultBackgroundColorValue) {
                document.getElementById('default-background-color').value = defaultBackgroundColorValue;
                document.documentElement.style.setProperty('--default-background-color', defaultBackgroundColorValue);
            }
            if (defaultColorValue) {
                document.getElementById('default-color').value = defaultColorValue;
                document.documentElement.style.setProperty('--default-color', defaultColorValue);
            }
            if (highlightColorValue) {
                document.getElementById('highlight-color').value = highlightColorValue;
                document.documentElement.style.setProperty('--highlight-color', highlightColorValue);
            }
            if (enableFontSizeValue !== null) {
                enableFontSize = enableFontSizeValue;
                document.getElementById('toggle-font-size').checked = enableFontSize;
            }
            if (enableOpacityValue !== null) {
                enableOpacity = enableOpacityValue;
                document.getElementById('toggle-opacity').checked = enableOpacity;
            }
            if (showEnglishValue !== null) {
                showEnglish = showEnglishValue;
                document.getElementById('toggle-english').checked = showEnglish;
            }
            if (showGujaratiValue !== null) {
                showGujarati = showGujaratiValue;
                document.getElementById('toggle-gujarati').checked = showGujarati;
            }
            if (transitionDurationValue) {
                document.getElementById('transition-duration').value = transitionDurationValue;
                document.documentElement.style.setProperty('--transition-duration', `${transitionDurationValue}ms`);
            }
            if (fontSizeValue) {
                document.getElementById('font-size').value = fontSizeValue;
            }
        }

        loadConfig();
        loadData();
    </script>
</body>

</html>