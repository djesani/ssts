<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kirtans</title>
    <style>
        :root {
            --backgroundColor: #fff2e6;
            --defaultColor: #990101;
            --highlightColor: #ff6a00;
            --transitionDuration: 500ms;
            --fontSize: 32;
        }

        body {
            background-color: var(--backgroundColor);
            overflow: hidden;
        }

        #title {
            font-size: 40px;
            text-align: center;
            color: var(--defaultColor);
        }

        ul {
            list-style: none;
            padding: 0;
        }

        .list-item {
            padding: 5px 0;
            font-size: var(--fontSize)px;
            color: var(--defaultColor);
            transition: all linear var(--transitionDuration);
            width: 100%;
            text-align: center;
            font-weight: normal;
            position: absolute;
        }

        .list-item.noAnimation {
            transition: none;
        }

        .english {
            font-weight: bold;
        }

        #config-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 300px;
            height: 100%;
            background-color: #e4ddd7;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
            transition: right 0.3s;
            padding: 20px;
            overflow-y: auto;
        }

        #config-panel.open {
            right: 0;
        }

        #config-panel label {
            display: block;
            margin: 15px 0 5px;
        }

        #config-panel input[type="color"],
        #config-panel select,
        #config-panel input[type="checkbox"] {
            width: 100%;
            min-height: 30px;
        }

        #config-panel input[type="checkbox"] {
            display: inline-block;
            margin-right: 5px;
        }

        #config-panel label.checkbox {
            display: flex;
        }

        #config-panel input[type="checkbox"] {
            margin: -4px 15px 0 0;
            width: 16px;
            height: 16px;
        }

        #panel-open {
            position: absolute;
            top: 0;
            right: 0;
        }
    </style>

    <style id="dynamic-styles"></style>
</head>

<body>
    <h1 id="title"></h1>
    <ul id="list" class="list"></ul>
    <button onclick="openConfigPanel()" id="panel-open">i</button>

    <div id="config-panel">
        <button onclick="closeConfigPanel()" id="panel-close">Close</button>
        <button onclick="saveConfig()">Save Config</button>
        <button onclick="resetConfig()">Reset Config</button>
        <label for="numLines">Lines</label>
        <select id="numLines" onchange="updateNumLines()">
            <option value="5">5</option>
            <option selected value="7">7</option>
            <option value="9">9</option>
            <option value="11">11</option>
        </select>

        <label for="backgroundColor">Background color</label>
        <input type="color" id="backgroundColor" value="#fff2e6" onchange="updateBackgroundColor()">

        <label for="defaultColor">Default color</label>
        <input type="color" id="defaultColor" value="#990101" onchange="updateDefaultColor()">

        <label for="highlightColor">Highlight color</label>
        <input type="color" id="highlightColor" value="#ff6a00" onchange="updateHighlightColor()">

        <label class="checkbox">
            <input type="checkbox" id="enableFontResizing" onchange="updateEnableFontResizing()">
            Enable font resizing
        </label>
        <label class="checkbox">
            <input type="checkbox" id="enableOpacity" onchange="updateEnableOpacity()">
            Enable opacity
        </label>
        <label class="checkbox">
            <input type="checkbox" id="showEnglish" onchange="updateEnglish()">
            Show English
        </label>
        <label class="checkbox">
            <input type="checkbox" id="showGujarati" onchange="updateGujarati()">
            Show Gujarati
        </label>

        <label for="transitionDuration">Transition duration (ms)</label>
        <select id="transitionDuration" onchange="updateTransitionDuration()">
            <option value="250">250</option>
            <option selected value="500">500</option>
            <option value="750">750</option>
            <option value="1000">1000</option>
            <option value="1250">1250</option>
            <option value="1500">1500</option>
        </select>

        <label for="fontSize">Font size (px)</label>
        <select id="fontSize" onchange="updateFontSize()">
            <option value="16">16</option>
            <option value="20">20</option>
            <option value="24">24</option>
            <option value="28">28</option>
            <option selected value="32">32</option>
            <option value="36">36</option>
            <option value="40">40</option>
            <option value="44">44</option>
            <option value="48">48</option>
        </select>

    </div>

    <script>
        let kirtanJson,
            slides,
            slidesGujarati,
            title,
            index = 0;
        let numLines = parseInt(localStorage.getItem('numLines')) || 7;
        let enableFontResizing = JSON.parse(localStorage.getItem('enableFontResizing')) ?? true;
        let enableOpacity = JSON.parse(localStorage.getItem('enableOpacity')) ?? true;
        let showEnglish = JSON.parse(localStorage.getItem('showEnglish')) ?? true;
        let showGujarati = JSON.parse(localStorage.getItem('showGujarati')) ?? true;
        let transitionDuration = localStorage.getItem('transitionDuration') || 500;
        let fontSize = localStorage.getItem('fontSize') || 32;
        const list = document.getElementById("list");
        const highlightIndex = Math.floor(numLines / 2) + 1;
        const stepsFromHighlight = highlightIndex - 1;

        document.addEventListener("keydown", (event) => {
            if (event.key === "ArrowUp") {
                if (index + stepsFromHighlight > 0) prev();
            } else if (event.key === "ArrowDown") {
                if (index - stepsFromHighlight < slides.length - numLines) next();
            }
        });

        async function loadData() {
            const response = await fetch("data.json");
            kirtanJson = await response.json();
            const id = getUrlParamsId();
            const kirtan = getKirtanById(id);
            title = kirtan.title_english;
            slides = kirtan.description_english.split("\n");
            slidesGujarati = kirtan.description_gujarati.split("\n");
            injectStyles(generateDynamicStyles(numLines));
            renderTitle();
            renderSlides();
            adjustToHighlightFirst();
        }

        function renderTitle() {
            document.getElementById("title").innerText = title;
        }

        function getKirtanById(id) {
            return kirtanJson.data.find((x) => x.id == id) || kirtanJson.data[0];
        }

        function getUrlParamsId() {
            const urlSearch = new URLSearchParams(window.location.search);
            return urlSearch.get("id") || 1;
        }

        function renderSlides() {
            list.innerHTML = "";
            for (let i = 0; i < numLines; i++) {
                const li = document.createElement("li");
                li.className = "list-item";

                const eng = document.createElement("div");
                eng.innerText = slides[index + i] || "";
                eng.className = "english";
                eng.style.display = showEnglish ? "block" : "none";

                const guj = document.createElement("div");
                guj.innerText = slidesGujarati[index + i] || "";
                guj.className = "gujarati";
                guj.style.display = showGujarati ? "block" : "none";

                li.appendChild(eng);
                li.appendChild(guj);
                list.appendChild(li);
            }
        }

        function prev() {
            transitionSlides("down", -1);
        }

        function next() {
            transitionSlides("up", 1);
        }

        function transitionSlides(animationClass, step) {
            updateAnimationClasses(false);
            list.classList.add(animationClass);
            setTimeout(() => {
                updateAnimationClasses(true);
                list.classList.remove(animationClass);
                updateIndex(step);
                renderSlides();
                adjustToHighlightFirst();
            }, transitionDuration);
        }

        function updateAnimationClasses(add) {
            document.querySelectorAll('.list-item').forEach(item => {
                if (add) {
                    item.classList.remove('noAnimation');
                } else {
                    item.classList.add('noAnimation');
                }
            });
        }

        function updateIndex(step) {
            index = (index + step + slides.length) % slides.length;
        }

        function adjustToHighlightFirst() {
            for (let i = 0; i < stepsFromHighlight; i++) {
                prev();
            }
        }

        function injectStyles(styles) {
            document.getElementById("dynamic-styles").innerHTML = styles;
        }

        function generateDynamicStyles(numLines) {
            let styles = '';
            for (let i = 0; i < numLines; i++) {
                const distance = Math.abs(i - highlightIndex + 1);
                const fontSizeRatio = enableFontResizing ? (1 - distance / (numLines - 1)) : 1;
                const opacity = enableOpacity ? (1 - distance / (numLines - 1)) : 1;
                styles += `
                    .list-item:nth-child(${i + 1}) {
                        font-size: calc(var(--fontSize) * ${fontSizeRatio}px);
                        opacity: ${opacity};
                    }
                `;
            }
            return styles;
        }

        function openConfigPanel() {
            document.getElementById("config-panel").classList.add("open");
        }

        function closeConfigPanel() {
            document.getElementById("config-panel").classList.remove("open");
        }

        function saveConfig() {
            const config = {
                numLines: document.getElementById("numLines").value,
                backgroundColor: document.getElementById("backgroundColor").value,
                defaultColor: document.getElementById("defaultColor").value,
                highlightColor: document.getElementById("highlightColor").value,
                enableFontResizing: document.getElementById("enableFontResizing").checked,
                enableOpacity: document.getElementById("enableOpacity").checked,
                showEnglish: document.getElementById("showEnglish").checked,
                showGujarati: document.getElementById("showGujarati").checked,
                transitionDuration: document.getElementById("transitionDuration").value,
                fontSize: document.getElementById("fontSize").value,
            };

            localStorage.setItem('numLines', config.numLines);
            localStorage.setItem('backgroundColor', config.backgroundColor);
            localStorage.setItem('defaultColor', config.defaultColor);
            localStorage.setItem('highlightColor', config.highlightColor);
            localStorage.setItem('enableFontResizing', config.enableFontResizing);
            localStorage.setItem('enableOpacity', config.enableOpacity);
            localStorage.setItem('showEnglish', config.showEnglish);
            localStorage.setItem('showGujarati', config.showGujarati);
            localStorage.setItem('transitionDuration', config.transitionDuration);
            localStorage.setItem('fontSize', config.fontSize);

            applyConfig(config);
        }

        function resetConfig() {
            localStorage.removeItem('numLines');
            localStorage.removeItem('backgroundColor');
            localStorage.removeItem('defaultColor');
            localStorage.removeItem('highlightColor');
            localStorage.removeItem('enableFontResizing');
            localStorage.removeItem('enableOpacity');
            localStorage.removeItem('showEnglish');
            localStorage.removeItem('showGujarati');
            localStorage.removeItem('transitionDuration');
            localStorage.removeItem('fontSize');
            loadConfig();
        }

        function loadConfig() {
            document.getElementById("numLines").value = numLines = parseInt(localStorage.getItem('numLines')) || 7;
            document.getElementById("backgroundColor").value = localStorage.getItem('backgroundColor') || "#fff2e6";
            document.getElementById("defaultColor").value = localStorage.getItem('defaultColor') || "#990101";
            document.getElementById("highlightColor").value = localStorage.getItem('highlightColor') || "#ff6a00";
            document.getElementById("enableFontResizing").checked = enableFontResizing = JSON.parse(localStorage.getItem('enableFontResizing')) ?? true;
            document.getElementById("enableOpacity").checked = enableOpacity = JSON.parse(localStorage.getItem('enableOpacity')) ?? true;
            document.getElementById("showEnglish").checked = showEnglish = JSON.parse(localStorage.getItem('showEnglish')) ?? true;
            document.getElementById("showGujarati").checked = showGujarati = JSON.parse(localStorage.getItem('showGujarati')) ?? true;
            document.getElementById("transitionDuration").value = transitionDuration = localStorage.getItem('transitionDuration') || 500;
            document.getElementById("fontSize").value = fontSize = localStorage.getItem('fontSize') || 32;

            applyConfig({
                numLines,
                backgroundColor: document.getElementById("backgroundColor").value,
                defaultColor: document.getElementById("defaultColor").value,
                highlightColor: document.getElementById("highlightColor").value,
                enableFontResizing,
                enableOpacity,
                showEnglish,
                showGujarati,
                transitionDuration,
                fontSize
            });
        }

        function applyConfig(config) {
            document.documentElement.style.setProperty('--backgroundColor', config.backgroundColor);
            document.documentElement.style.setProperty('--defaultColor', config.defaultColor);
            document.documentElement.style.setProperty('--highlightColor', config.highlightColor);
            document.documentElement.style.setProperty('--transitionDuration', `${config.transitionDuration}ms`);
            document.documentElement.style.setProperty('--fontSize', config.fontSize);
            numLines = config.numLines;
            enableFontResizing = config.enableFontResizing;
            enableOpacity = config.enableOpacity;
            showEnglish = config.showEnglish;
            showGujarati = config.showGujarati;
            transitionDuration = config.transitionDuration;
            fontSize = config.fontSize;

            injectStyles(generateDynamicStyles(numLines));
            renderSlides();
            adjustToHighlightFirst();
        }

        window.onload = () => {
            loadData();
            loadConfig();
        };

        function updateNumLines() {
            numLines = parseInt(document.getElementById("numLines").value);
            injectStyles(generateDynamicStyles(numLines));
            renderSlides();
            adjustToHighlightFirst();
        }

        function updateBackgroundColor() {
            document.documentElement.style.setProperty('--backgroundColor', document.getElementById("backgroundColor").value);
        }

        function updateDefaultColor() {
            document.documentElement.style.setProperty('--defaultColor', document.getElementById("defaultColor").value);
        }

        function updateHighlightColor() {
            document.documentElement.style.setProperty('--highlightColor', document.getElementById("highlightColor").value);
        }

        function updateEnableFontResizing() {
            enableFontResizing = document.getElementById("enableFontResizing").checked;
            injectStyles(generateDynamicStyles(numLines));
        }

        function updateEnableOpacity() {
            enableOpacity = document.getElementById("enableOpacity").checked;
            injectStyles(generateDynamicStyles(numLines));
        }

        function updateEnglish() {
            showEnglish = document.getElementById("showEnglish").checked;
            renderSlides();
        }

        function updateGujarati() {
            showGujarati = document.getElementById("showGujarati").checked;
            renderSlides();
        }

        function updateTransitionDuration() {
            transitionDuration = document.getElementById("transitionDuration").value;
            document.documentElement.style.setProperty('--transitionDuration', `${transitionDuration}ms`);
        }

        function updateFontSize() {
            fontSize = document.getElementById("fontSize").value;
            document.documentElement.style.setProperty('--fontSize', fontSize);
            injectStyles(generateDynamicStyles(numLines));
        }
    </script>
</body>

</html>
